@startuml TMC-Balikpapan-Sequence-Diagrams

title TMC Balikpapan System Sequence Diagrams

' Define participants
participant "User" as User
participant "Browser" as Browser
participant "Web Server" as Server
participant "API Controller" as API
participant "Database" as DB
participant "Streaming Service" as Stream
participant "CDN" as CDN
participant "Admin Dashboard" as Admin

' 1. TMC Balikpapan Public Portal - Complete Features Flow
group TMC Balikpapan Public Portal - Live CCTV Streaming, Interactive Map, Location-based Access, Real-time Traffic Monitoring
    User -> Browser: Access public portal (/)
    Browser -> Server: GET /
    Server -> Server: Load all required data
    Server -> DB: Query locations with CCTV data
    DB --> Server: Return locations & cctvs
    Server -> DB: Query news for topbar
    DB --> Server: Return news data
    Server -> DB: Query contact information
    DB --> Server: Return contacts data
    Server -> Browser: Render index.blade.php
    
    ' Display all portal sections
    Browser -> Browser: Display home section with slider
    Browser -> Browser: Display interactive map section
    Browser -> Browser: Display streaming section grouped by kecamatan
    Browser -> Browser: Display contact section
    
    ' Interactive Map - Location-based Access
    User -> Browser: Click map section
    Browser -> Browser: Initialize Leaflet map
    Browser -> Browser: Load OpenStreetMap tiles
    Browser -> Server: GET /api/locations
    Server -> API: Forward request
    API -> DB: Query all locations
    DB --> API: Return locations with coordinates
    API --> Server: Return JSON locations
    Server --> Browser: Return locations data
    Browser -> Browser: Add markers for each location
    
    User -> Browser: Click location marker on map
    Browser -> Browser: Show popup with location details
    Browser -> Browser: Display CCTV list in popup
    
    ' Real-time Traffic Monitoring via CCTV
    User -> Browser: Select CCTV from map popup
    Browser -> Browser: Trigger open-stream event
    Browser -> Server: GET /cctv/{cctv_id}
    Server -> DB: Get CCTV details
    DB --> Server: Return CCTV info (name, status, type)
    Server -> Browser: Render CCTV show page
    Browser -> Stream: Request HLS stream (.m3u8)
    Stream -> CDN: Fetch video segments
    CDN --> Stream: Return video segments
    Stream --> Browser: Stream live HLS video
    
    ' Location-based Access via Streaming Section
    User -> Browser: Navigate to streaming section
    Browser -> Browser: Group CCTV by kecamatan
    Browser -> Server: GET /api/cctv
    Server -> API: Forward request
    API -> DB: Query all CCTV with locations
    DB --> API: Return CCTV grouped by kecamatan
    API --> Server: Return JSON data
    Server --> Browser: Return streaming data
    
    User -> Browser: Click kecamatan accordion
    Browser -> Browser: Expand CCTV list for kecamatan
    
    User -> Browser: Click "Live" button on specific CCTV
    Browser -> Browser: Open streaming modal
    Browser -> Server: GET /cctv/{cctv_id}
    Server -> DB: Get CCTV details
    DB --> Server: Return CCTV info
    Server -> Browser: Render streaming interface
    Browser -> Stream: Request HLS stream
    Stream -> CDN: Fetch video segments
    CDN --> Stream: Return segments
    Stream --> Browser: Stream live video
    
    ' Real-time Updates
    Browser -> API: GET /api/cctv (periodic refresh)
    API -> DB: Query latest CCTV status
    DB --> API: Return updated CCTV data
    API --> Browser: Return JSON updates
    Browser -> Browser: Update status indicators
    
    ' Location-based Filtering
    User -> Browser: Select kecamatan filter
    Browser -> Browser: Filter map markers by kecamatan
    Browser -> Browser: Filter streaming list by kecamatan
    Browser -> Browser: Update displayed locations
end

' 2. Video Streaming System - HLS Streaming Flow
group Video Streaming System - HLS Protocol
    User -> Browser: Request live stream
    Browser -> API: GET /api/cctv/{id}/stream
    API -> DB: Validate CCTV exists
    DB --> API: Return CCTV details
    API -> Stream: Initialize HLS stream
    Stream -> Stream: Process RTSP to HLS
    Stream -> CDN: Upload segments
    CDN --> Stream: Confirm upload
    Stream --> API: Return stream URL
    API --> Browser: Return HLS URL
    Browser -> CDN: Request .m3u8 playlist
    CDN --> Browser: Return playlist
    Browser -> CDN: Request video segments
    CDN --> Browser: Stream video segments
end

' 3. Map Integration System - Interactive Map Flow
group Map Integration System - Interactive Map
    User -> Browser: Access map section
    Browser -> Server: Load map partial
    Server -> DB: Query locations with CCTV
    DB --> Server: Return locations data
    Server -> Browser: Render map.blade.php
    
    Browser -> Browser: Initialize Leaflet map
    Browser -> Browser: Add markers for locations
    
    User -> Browser: Click map marker
    Browser -> Browser: Show popup with CCTV list
    User -> Browser: Click CCTV in popup
    Browser -> Browser: Trigger open-stream event
    Browser -> Browser: Display streaming window
    Browser -> Server: GET /cctv/{id}
    Server -> DB: Get CCTV details
    DB --> Server: Return CCTV info
    Server -> Browser: Render streaming interface
end

' 4. Admin Dashboard - General Management Flow
group Admin Dashboard - General Management
    User -> Browser: Login as admin
    Browser -> Server: POST /login
    Server -> DB: Validate credentials
    DB --> Server: Return user data
    Server -> Admin: Initialize admin session
    Admin -> Browser: Redirect to admin/dashboard
    
    User -> Browser: Navigate to any CRUD section
    Browser -> Admin: Request management interface
    Admin -> DB: Query relevant data
    DB --> Admin: Return data
    Admin -> Browser: Render management interface
    
    User -> Browser: Perform CRUD operation
    Browser -> Admin: Submit CRUD request
    Admin -> DB: Execute database operation
    DB --> Admin: Confirm operation
    Admin -> Browser: Redirect with success
end

' 5. News & Information System - Topbar News Selection
group News & Information System - Topbar Selection
    User -> Browser: Login as admin
    Browser -> Admin: Access dashboard
    Admin -> DB: Query available news
    DB --> Admin: Return news list
    Admin -> Browser: Render news selection widget
    
    User -> Browser: Select news & scope
    Browser -> Admin: POST dashboard/update-news
    Admin -> Admin: Validate selection
    Admin -> Admin: Store in session
    Admin -> Browser: Redirect with success
    
    User -> Browser: Visit public portal
    Browser -> Server: GET /
    Server -> Admin: Check selected news
    Admin -> DB: Get selected news details
    DB --> Admin: Return news content
    Admin -> Server: Return news data
    Server -> Browser: Render with topbar news
end

' 6. API Service Layer - RESTful Endpoints Flow
group API Service Layer - RESTful API
    Client -> API: GET /api/cctv
    API -> DB: Query all CCTV
    DB --> API: Return CCTV list
    API --> Client: Return JSON response
    
    Client -> API: GET /api/cctv/{id}
    API -> DB: Find CCTV by ID
    DB --> API: Return CCTV details
    API --> Client: Return JSON response
    
    Client -> API: GET /api/news
    API -> DB: Query all news
    DB --> API: Return news list
    API --> Client: Return JSON response
    
    Client -> API: GET /api/locations
    API -> DB: Query all locations
    DB --> API: Return locations list
    API --> Client: Return JSON response
end

' 7. Responsive Web Interface - Mobile Flow
group Responsive Web Interface - Mobile Experience
    User -> Browser: Access on mobile device
    Browser -> Server: GET / (mobile viewport)
    Server -> Server: Detect mobile
    Server -> DB: Query optimized data
    DB --> Server: Return data
    Server -> Browser: Render mobile-optimized view
    
    User -> Browser: Tap streaming section
    Browser -> Browser: Expand location accordion
    User -> Browser: Tap "Live" button
    Browser -> Browser: Open full-screen modal
    Browser -> Stream: Request mobile-optimized HLS
    Stream -> CDN: Fetch mobile segments
    CDN --> Stream: Return mobile video
    Stream --> Browser: Stream mobile HLS
end

' 8. Database & Configuration - System Initialization
group Database & Configuration - System Setup
    Server -> DB: Run migrations
    DB -> DB: Create tables
    DB --> Server: Migration complete
    
    Server -> DB: Run seeders
    DB -> DB: Insert sample data
    DB --> Server: Seeding complete
    
    Server -> Server: Load configuration
    Server -> Server: Initialize services
    Server -> Browser: System ready
end

@enduml
